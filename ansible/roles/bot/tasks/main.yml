---
- name: create bot user
  user:
    name: '{{ bot_user }}'
    system: yes

- name: create bot dir
  file:
    path: '{{ bot_basedir }}'
    state: directory
    owner: '{{ bot_user }}'

- name: copy bot files
  copy:
    src: '../{{ item }}'
    dest: '{{ bot_basedir }}/{{ item }}'
    owner: '{{ bot_user }}'
  notify: restart bot
  with_items:
    - 'calbot.py'
    - 'requirements.txt'
    - 'COPYING'
    - 'calbot/'

- name: install dependencies
  pip:
    executable: /usr/bin/pip3
    requirements: '{{ bot_basedir }}/requirements.txt'
  notify: restart bot

- name: create config
  template:
    src: bot.cfg
    dest: '{{ bot_basedir }}/{{ bot_service_name }}.cfg'
  notify: restart bot

- name: install systemd service
  template:
    src: bot.service
    dest: '/etc/systemd/system/{{ bot_service_name }}.service'
  notify: reload systemd

- name: enable service
  service:
    name: '{{ bot_service_name }}'
    enabled: yes

- name: start service
  service:
    name: '{{ bot_service_name }}'
    state: started
